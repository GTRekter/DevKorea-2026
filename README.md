# DevKorea Multicloud GitOps Demo

GitOps sample for Linkerd Enterprise + Argo CD across multiple clusters. The active path today is Naver Cloud NKS (two clusters); the Azure AKS module remains available but is disabled until the subscription is reactivated.

## Repository Layout
- `terraform/naver`: Provisions two NKS clusters with VPC/subnets/peering and deploys Argo CD + Linkerd Enterprise via ApplicationSets.
- `terraform/azure`: Provision AKS stack (one cluster with VNet, and Node pools) if you have an active Azure subscription.
- `terraform/`: Root wiring and helpers (null_resources for kubeconfigs + Linkerd link generation).
- `manifests/`: Generated Linkerd multicluster credentials/secrets and sample `simple-app` workloads for each cluster.

## Default Path: Naver Cloud NKS
### What it creates
- Two NKS clusters with dedicated VPCs/subnets plus peering.
- Argo CD via Helm on `devkorea-nks-1` (LoadBalancer) with service accounts/tokens/role bindings so Argo CD can manage both clusters.
- Linkerd Enterprise CRDs, control plane, and multicluster gateways via Argo CD ApplicationSets. TLS identity materials are generated by Terraform.
- Optional helpers (in `terraform/`) to emit kubeconfigs to `./kubeconfig-*.yaml` and Linkerd link secrets under `manifests/devkorea-nks-*/linkerd/`.

### Prerequisites
- Terraform CLI 1.6+; `kubectl`; Helm CLI (for troubleshooting).
- `ncp-iam-authenticator`:
  ```sh
  brew tap NaverCloudPlatform/tap
  brew install ncp-iam-authenticator
  export NCLOUD_API_GW="https://ncloud.apigw.ntruss.com"
  ```
- Naver Cloud credentials: `access_key`, `secret_key`, `account_id` (keep in env vars or an untracked tfvars file).
- Linkerd Enterprise license (base64) and optional `linkerd_enterprise_version` override (default `2.19.4`).
- Argo CD admin password + bcrypt hash:
  ```sh
  ARGO_PWD="choose-a-strong-password"
  ARGO_PWD_BCRYPT=$(argocd account bcrypt --password "$ARGO_PWD")
  export TF_VAR_argocd_admin_password="$ARGO_PWD"
  export TF_VAR_argocd_admin_password_bcrypt="$ARGO_PWD_BCRYPT"
  ```

### Deploy NKS + Argo CD + Linkerd
1. Create `terraform/naver/development.tfvars` (do not commit):
   ```hcl
   access_key                  = "NCLOUD_ACCESS_KEY"
   secret_key                  = "NCLOUD_SECRET_KEY"
   account_id                  = "NCLOUD_ACCOUNT_ID"
   linkerd_enterprise_license  = "BASE64_LICENSE_STRING"
   # linkerd_enterprise_version = "2.19.4"
   # argocd_admin_password and argocd_admin_password_bcrypt can come from TF_VARs instead of this file
   ```
2. Initialize and apply:
   ```sh
   terraform -chdir=terraform init
   terraform -chdir=terraform apply -var-file=development.tfvars
   ```





   
3. Build kubeconfigs (if you are not using the root null_resources):
   ```sh
   NKS1_UUID=$(terraform -chdir=terraform/naver state show 'ncloud_nks_cluster.clusters["devkorea-nks-1"]' | awk -F'"' '/uuid/ {print $2}')
   ncp-iam-authenticator create-kubeconfig --region KR --clusterUuid "$NKS1_UUID" --output ./kubeconfig-devkorea-nks-1.yaml

   NKS2_UUID=$(terraform -chdir=terraform/naver state show 'ncloud_nks_cluster.clusters["devkorea-nks-2"]' | awk -F'"' '/uuid/ {print $2}')
   ncp-iam-authenticator create-kubeconfig --region KR --clusterUuid "$NKS2_UUID" --output ./kubeconfig-devkorea-nks-2.yaml
   ```
4. (Optional) Regenerate Linkerd link credentials manually:
   ```sh
   linkerd multicluster link-gen --kubeconfig=./kubeconfig-devkorea-nks-1.yaml --cluster-name devkorea-nks-1 > ./manifests/devkorea-nks-2/linkerd/credentials-devkorea-nks-1.yaml
   linkerd multicluster link-gen --kubeconfig=./kubeconfig-devkorea-nks-2.yaml --cluster-name devkorea-nks-2 > ./manifests/devkorea-nks-1/linkerd/credentials-devkorea-nks-2.yaml
   ```

### Access Argo CD
- Fetch the LoadBalancer hostname/IP:
  ```sh
  kubectl --kubeconfig ./kubeconfig-devkorea-nks-1.yaml -n argocd get svc argocd-server
  ```
- Log in with user `admin` and the password you set in `TF_VAR_argocd_admin_password`.

## Optional: Azure AKS (disabled by default)
- The Azure module lives in `terraform/azure`; `aks_cluster_instances` is empty in `terraform/locals.tf` and the module call in `terraform/main.tf` is commented until the subscription is reactivated.
- To use it with an active subscription:
  1. Create `terraform/azure/dev.tfvars` with `tenant_id`, `subscription_id`, `client_id`, `client_secret`, `linkerd_enterprise_license`, and optional `linkerd_enterprise_version`.
  2. Bootstrap Argo CD, then apply the full stack:
     ```sh
     terraform -chdir=terraform/azure init
     terraform -chdir=terraform/azure apply -var-file=dev.tfvars -target=helm_release.argocd
     export TF_VAR_argocd_admin_password=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
     terraform -chdir=terraform/azure apply -var-file=dev.tfvars
     ```
- If you later want to run Azure via the root module, re-enable entries in `terraform/locals.tf` and uncomment the Azure module block in `terraform/main.tf`.

## Linkerd Credentials, Workloads, and Validation
- Pre-generated Linkerd link secrets live under `manifests/devkorea-*/linkerd/` (AKS and NKS variants).
- Sample multicluster workloads are under `manifests/devkorea-*/simple-app/`; apply them to the corresponding clusters, then use `kubectl -n simple-app get pods,svc -o wide` or exec into the `curl` pod for traffic checks.

## Cleanup
- Naver stack: `terraform -chdir=terraform/naver destroy -var-file=dev.tfvars`
- Azure stack (if enabled): `terraform -chdir=terraform/azure destroy -var-file=dev.tfvars`
