# DevKorea Multicloud GitOps Demo

Terraform, Helm, and Argo CD are used together to spin up and manage multiple Kubernetes clusters. The primary target is Azure AKS (two clusters by default) with Linkerd Enterprise deployed through Argo CD. An optional Naver Cloud NKS stack is included for additional demos.

## Repository Layout
- `terraform/azure`: Provisions AKS clusters, networking, Argo CD, registers clusters with Argo CD, and bootstraps Linkerd Enterprise via ApplicationSets.
- `terraform/naver`: Standalone Naver Cloud NKS cluster with VPC/subnets.
- `manifests/`: Pre-generated Linkerd multicluster credentials/secrets for manual linkage between the AKS clusters.

## What the Azure Stack Creates
- One resource group in `Korea Central`.
- Per-cluster virtual networks, subnets, and full mesh VNet peering between clusters.
- Two AKS clusters (`devkorea-aks-1` and `devkorea-aks-2`) with system and user node pools.
- Argo CD installed via Helm on `devkorea-aks-1` (LoadBalancer service for the server).
- Service accounts, tokens, and cluster role bindings so Argo CD can manage both clusters.
- An Argo CD project plus ApplicationSets that install Linkerd Enterprise CRDs and control plane to every registered cluster, plus a per-cluster multicluster gateway app. TLS identity materials (trust anchor and issuer) are generated by Terraform.

## Prerequisites
- Terraform CLI (1.6+ recommended; Naver module supports >=0.13).
- kubectl; Helm CLI (useful for debugging).
- Azure service principal with rights to create RG/VNet/AKS; values for `tenant_id`, `subscription_id`, `client_id`, `client_secret`.
- Linkerd Enterprise license (base64 encoded, as it is written to a Kubernetes Secret `data` field) and optional target version (default `2.19.4`).
- Ability to reach the AKS API servers from where you run Terraform (argocd provider port-forwards to the Argo CD API).
- Naver Cloud credentials if using the NKS example.

## Deploying Azure AKS + Argo CD + Linkerd
1. Create a tfvars file (do not commit it), e.g. `terraform/azure/dev.tfvars`:
   ```hcl
   tenant_id                  = "00000000-0000-0000-0000-000000000000"
   subscription_id            = "00000000-0000-0000-0000-000000000000"
   client_id                  = "00000000-0000-0000-0000-000000000000"
   client_secret              = "your-sp-secret"
   linkerd_enterprise_license = "BASE64_LICENSE_STRING"
   # linkerd_enterprise_version = "2.19.4" # override if needed
   ```
2. Initialize Terraform:
   ```sh
   cd terraform/azure
   terraform init
   ```
3. Bootstrap infrastructure and install Argo CD (creates RG/VNets/AKS and the Helm release, but skips Argo CD-managed resources):
   ```sh
   terraform apply -var-file=dev.tfvars -target=helm_release.argocd
   ```
4. Capture the Argo CD admin password from the new cluster and export it so the argocd provider can authenticate:
   ```sh
   kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d; echo
   export TF_VAR_argocd_admin_password=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
   ```
5. Apply the full configuration to register the clusters, create the Argo CD project/ApplicationSets, and roll out Linkerd Enterprise:
   ```sh
   terraform apply -var-file=dev.tfvars
   ```
6. Access Argo CD (optional):
   ```sh
   kubectl -n argocd port-forward svc/argocd-server 8080:443
   # then browse to https://localhost:8080 with user 'admin' and the password from step 4
   ```

### Working with Additional Clusters
Update `local.cluster_instances` in `terraform/azure/locals.tf` to add/remove clusters (key = cluster name, value = unique index). Apply again to provision and register them; the Linkerd ApplicationSets will automatically target any Argo CD cluster secret labeled with `argocd.argoproj.io/secret-type=cluster`.

### Using the Pre-built Linkerd Credentials
If you need to recreate the multicluster Link resources manually (outside of Terraform/Argo CD), the files in `manifests/credentials-devkorea-aks-*.yaml` contain the kubeconfig secrets and `Link` objects for `devkorea-aks-1` and `devkorea-aks-2`.

### Applications

```
[devkorea-aks-1|default] gtrekter@MacBook-Pro-M4 azure % kubectl get pods,svc -n simple-app -o wide                                        
NAME                                     READY   STATUS    RESTARTS   AGE     IP            NODE                            NOMINATED NODE   READINESS GATES
pod/curl                                 1/1     Running   0          9s      10.240.2.25   aks-linux-33822179-vmss000000   <none>           <none>
pod/traffic-federated-554b7b6cc5-kpglw   2/2     Running   0          14m     10.240.1.18   aks-linux-33822179-vmss000001   <none>           <none>
pod/traffic-gateway-7968f4b4d8-tvklg     2/2     Running   0          4m36s   10.240.1.20   aks-linux-33822179-vmss000001   <none>           <none>
pod/traffic-mirrored-557d5545d6-nbrbn    2/2     Running   0          4m36s   10.240.2.24   aks-linux-33822179-vmss000000   <none>           <none>

NAME                                            TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE   SELECTOR
service/simple-app-v1-federated-federated       ClusterIP   10.16.92.231   <none>        80/TCP    14m   <none>
service/simple-app-v1-gateway-devkorea-aks-2    ClusterIP   10.16.56.4     <none>        80/TCP    14m   <none>
service/simple-app-v1-mirrored-devkorea-aks-2   ClusterIP   10.16.223.54   <none>        80/TCP    14m   <none>

```

```
[devkorea-aks-2|default] gtrekter@MacBook-Pro-M4 azure % kubectl get pods,svc -n simple-app -o wide
NAME                                           READY   STATUS    RESTARTS   AGE   IP            NODE                            NOMINATED NODE   READINESS GATES
pod/curl                                       1/1     Running   0          33s   10.241.7.22   aks-linux-16720906-vmss000000   <none>           <none>
pod/simple-app-57dc8d99d6-hrgsf                2/2     Running   0          23m   10.241.7.14   aks-linux-16720906-vmss000000   <none>           <none>
pod/simple-app-v1-federated-6b699675c4-wpf75   2/2     Running   0          18m   10.241.7.17   aks-linux-16720906-vmss000000   <none>           <none>
pod/simple-app-v1-gateway-57dc8d99d6-97gs7     2/2     Running   0          18m   10.241.9.11   aks-linux-16720906-vmss000001   <none>           <none>
pod/simple-app-v1-mirrored-59c6f4ffb8-x2jqq    2/2     Running   0          18m   10.241.7.16   aks-linux-16720906-vmss000000   <none>           <none>

NAME                                        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE   SELECTOR
service/simple-app                          ClusterIP   10.17.181.198   <none>        80/TCP    32m   app=simple-app,mode=federated,version=v1
service/simple-app-v1-federated             ClusterIP   10.17.211.192   <none>        80/TCP    15m   app=simple-app,mode=federated,version=v1
service/simple-app-v1-federated-federated   ClusterIP   10.17.173.9     <none>        80/TCP    15m   <none>
service/simple-app-v1-gateway               ClusterIP   10.17.184.234   <none>        80/TCP    24m   app=simple-app,mode=gateway,version=v1
service/simple-app-v1-mirrored              ClusterIP   10.17.16.137    <none>        80/TCP    24m   app=simple-app,mode=mirrored,version=v1
```

```
kubectl exec -n simple-app curl -c curl -- curl -vvv 10.17.211.192:5678
07:55:16.957498 [0-x] * [READ] client_reset, clear readers
07:55:16.957651 [0-0] * [SETUP] added
  % Total    % Received % Xferd  Average Speed  Time    Time    Time   Current
                                 Dload  Upload  Total   Spent   Left   Speed
  0      0   0      0   0      0      0      0                              007:55:16.958015 [0-0] *   Trying 10.17.211.192:5678...
07:55:16.958204 [0-0] * [SETUP] Curl_conn_connect(block=0) -> 0, done=0
07:55:17.959399 [0-0] * [SETUP] Curl_conn_connect(block=0) -> 0, done=0
```


## Naver Cloud NKS (Optional)
Creates a simple NKS cluster with VPC and subnets.
```sh
cd terraform/naver
terraform init
terraform plan  # accepts -var overrides for project_suffix, region, zone, node_count, node_storage_size
terraform apply
```

## Cleanup
- Azure stack: `cd terraform/azure && terraform destroy -var-file=dev.tfvars`
- Naver stack: `cd terraform/naver && terraform destroy`


